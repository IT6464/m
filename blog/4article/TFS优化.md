#TFS优化


背景
====

我们在最开始使用TFS时，有一些小技巧和实践可以让用户更好的使用TFS的各项功能。而且在维护TFS的过程中，有时会发现数据库占用的空间飞快增长，对存储成本较敏感的企业可能会比较在意这方面的问题。另外随着对TFS的使用，用户规模和团队项目规模也会慢慢变大，有时访问TFS是明显感觉比较慢。

因此，在这里总结了一些技巧和实践，希望借此机会能和大家分享交流。文档用于指导团如何使用TFS的功能，以适应TFS将来的规模化使用带来的存储压力。

## 概述

众所周知，TFS产生的各项数据都是存储在SqlServer 数据库中的。通常占用空间往是一些二进制文件，文件文件并不会占太多空间

-   工作项中的附件，如文档、图片、压缩包等（相对占用较小，尽量通过链接方式提供相关资源）

-   文档的存放，如研发过程中的文档

-   源代码的存放，比如源码文件、或是二进制文件

-   构建包的存放，比如Jar包、dll等

-   测试结果的存放，如测试截图，视频，附件等二进制文件

版本库
======

将文档存放至版本库
------------------

在TFS中，有两种版本控制系统：TFVC和Git，TFVC是老式的集中式管理，Git是分布式管理。Git的方式更适合于现代的企业，也优先推荐使用Git。

对于文档，建议采用专门的文档版本存储方案，如SharePoint。不具备此条件时，再考虑将文档存放至源码版本库。存放至源码版本库文档尽量使用文本格式，比如Markdown格式，这样文档修改后保存的是增量，并不会占用太多数据库存储空间。在TFS2017及以上版本，还可以采用内置的Wiki库来存放技术文档。

如果确实需要将Office文档存放至TFS，建议采用TFVC源码版本库，而不是采用Git存储库，因为TFVC对于二进制文件有更好的性能。如果采用这种方式，建议对TFVC的存储目录根据实际的情况进行规划，规范文档存放的目录结构。

代码存放建议
------------

源码通常是文本文件，每次变化保存的是增量，所以源码文件本身不会占用太多的存储空间。占用大量存储空间的通常是一些编异后的中间文件、或是第三方组件包。在迁移代码库至TFS
Git时（或者是对现有的Git仓库）,建议对代码库分析和梳理, 清理不必要的二进制文件,
对于编异后的中间文件、或是依赖的第三方组件包有以下几种方式进行存放：

-   存放至统一的代码版本库中，需要时将版本库里面的包获取至本地，再引用至项目中

-   存放至统一的文件服务器，如Windows文件共享、FTP服务器、HTTP文件服务器等。需要至获取至本地，再引用至项目中

-   引入私有的包管理器(或是第三方商业包管理方案)，在企业内部搭建私有的程序包管理仓库，项目中不在直接引用依赖包，而是在需要运行时再从包管理仓库中自动下载依赖包。

-   使用TFS内置的Package Management, TFS2018官方已经支持
    NuGet、npm、Maven、Gradle四种包管理源

前面两种方式适用于团队规模较小，项目较少，依赖包复用率不高的场景。后两种是最优实现方式，但实现起来有一些成本，适应于多产品、多项目团队

 Git单个文件大限制
------------------

可以设置Git存储库中单个文件最大的大小，建议设置为100M

![](media/5fa3a654023d264c1902d1735d3d26d2.png)

构建包
======

在TFS的CI/CD中，构建包的存储方式有两种： \`Visual Studio Team Services/TFS \|
Server 和 a file
share\`。对于一个构建定义执行的历史记录，可以配置保留的周期和自动清理时清理的内容。如下图：

![](media/e6d51c41d827b2b62df8ad6f5bd68a44.png)

Figure 1 TFS 生成和发布定期清理策略-集合级别

![](media/ffd79f6f3a640164f3205c1b6fc63b79.png)

Figure 2 发布保留策略-团队项目 级别

![](media/8693fba462de2d2ee50a25578a5988c9.png)

Figure 3 生成清理内容配置

构建包的存储方式：

-   **Visual Studio Team Services**

>   这种方式简单粗暴，是将构建包直接存放至TFS的后台数据库中。这种方式固然简单，但是**构建包比较大、团队规模较大、构建数量比较多时，数据库将迅速增长**，对于比较在意DB存储成本的团队或组织来说，这种存放方式变得不太合适

-   **a file share**

>   这种方式是将构建包存放至Windows共享目录中，但是不支持Linux构建环境，**仅支持Windows构建环境**。如果偿试将Linux
>   构建环境中的构建包复制至Windows
>   共享目录，在TFS的构建定义中将会收到以下**错误**：\`**无法将来自 OSX 或 Linux
>   代理的项目发布到文件共享。可将项目类型更改为服务器或使用 Windows 代理**\`

为解决这个问题，我们需要考虑其他方案，**有两种可选方案**：ftp的方式和SSH的方式，FTP的方式会比较通用，对于Windows的构建环境也支持。SSH的方式针对纯Linux环境，纯Linux的构建环境建议采用这种方式。这两种实现方式可参考附件中导出的构建定义，将导出的构建定义Json文件导入到TFS中即可查看到效果

测试
====

在执行 手工测试（Test
Run）时、触发CICD部署流水线后（测试结果、及代码分析结果）、使用Test
Manager工具（会产生图片、附件、录屏）、浏览器测试插件Test &
Feedback（产生图片、附件录屏） 等
所产生的数据都存储在数据库中，而且包括大量的二进制文件，会占用比较大的数据库存储空间，通常我们在TFS中可以配置这些数据保留的期限，如下图：

![](media/9fbb3a4883f44945fd89b19581381a20.png)

如果经过分析后，测试部分还是会占用很大一部分空间，可以使用专用的工具Tcmpt 清理。

参考资料：

-   <https://docs.microsoft.com/en-us/vsts/manual-test/getting-started/how-long-to-keep-test-results?view=vsts>

-   <http://blogs.microsoft.co.il/shair/2014/06/29/controlreduce-tfs-db-size/>

TFS 数据占用分析
================

请参考以下文章：

-   <https://mattyrowan.com/2014/04/02/need-help-tfs-tbl_content-table-and-database-growth-out-of-control/>

-   <https://naveenalm.wordpress.com/2015/08/04/dar/>

TFS 数据库磁盘占用监控
======================

请参考此文章：

<https://naveenalm.wordpress.com/2015/08/08/use-stored-procedure-and-sql-job-to-setup-and-monitor-for-low-disk-alerts/>
